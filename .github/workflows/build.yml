# -----------------------------------------------------------------------------
# Workflow Name: Go Backend CI (Build & Test)
#
# Description:
# This workflow is the primary quality gate for the ShopAlly backend.
# It automatically runs on every push and pull request to the 'main' branch
# to ensure that all code compiles, passes tests, is correctly formatted,
# and adheres to linting standards before it can be merged.
# -----------------------------------------------------------------------------
name: Go Backend CI

# -----------------------------------------------------------------------------
# Trigger Conditions: When to run this workflow
# -----------------------------------------------------------------------------
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

# -----------------------------------------------------------------------------
# Jobs: The tasks to be executed
# -----------------------------------------------------------------------------
jobs:
  verify-and-build:
    runs-on: ubuntu-latest

    steps:
      # --- Step 1: SETUP ---
      - name: ‚úÖ 1. Checkout Repository Code
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è 2. Set up Go Environment
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true

      # --- Step 2: CODE QUALITY CHECKS ---
      - name: üßπ 3. Run Linter (golangci-lint)
        uses: golangci/golangci-lint-action@v3
        with:
          version: latest
          install-mode: goinstall   # ‚úÖ ensures linter builds with Go 1.25

      - name: üé® 4. Check Code Formatting (gofmt)
        run: |
          if [ -n "$(gofmt -l .)" ]; then
            echo "Go code is not formatted:"
            gofmt -l .
            exit 1
          fi

      - name: üì¶ 5. Verify Go Modules
        run: |
          go mod tidy
          if ! git diff --exit-code go.mod go.sum; then
            echo "go.mod or go.sum is out of date after running 'go mod tidy'"
            exit 1
          fi

      # --- Step 3: TESTING & BUILDING ---
      - name: üß™ 6. Run Tests (with Race Detector)
        run: go test -v -race ./...

      - name: üèóÔ∏è 7. Build Application
        run: go build -v ./...
