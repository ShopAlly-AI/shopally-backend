jobs:
  verify-and-build:
    runs-on: ubuntu-latest

    steps:
      - name: âœ… 1. Checkout Repository Code
        uses: actions/checkout@v4

      - name: âš™ï¸ 2. Set up Go Environment
        uses: actions/setup-go@v5.0.1
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: ğŸ“¦ 3. Verify Go Modules
        run: |
          go mod tidy

          # Collect only existing files (go.mod is guaranteed, go.sum may not exist yet)
          files_to_check=""
          [ -f go.mod ] && files_to_check="$files_to_check go.mod"
          [ -f go.sum ] && files_to_check="$files_to_check go.sum"

          if ! git diff --exit-code -- $files_to_check; then
            echo "go.mod or go.sum is out of date after running 'go mod tidy'"
            exit 1
          fi

      # --- Step 4: CODE QUALITY CHECKS ---
      - name: ğŸ§¹ 4. Run Linter (golangci-lint)
        uses: golangci/golangci-lint-action@v3
        with:
          version: latest
          install-mode: goinstall

      - name: ğŸ¨ 5. Check Code Formatting (gofmt)
        run: |
          if [ -n "$(gofmt -l .)" ]; then
            echo "Go code is not formatted:"
            gofmt -l .
            exit 1
          fi

      - name: ğŸ§ª 6. Run Tests (with Race Detector)
        run: go test -v -race ./...

      - name: ğŸ—ï¸ 7. Build Application
        run: go build -v ./...
